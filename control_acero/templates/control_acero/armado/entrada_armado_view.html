{% extends 'control_acero/layout.html' %}
{% block title_module %}
	ARMADO RECEPCIÓN
{% endblock %}
{% block content %}
	<div class="col-xs-12">
		<div class="form-group col-md-6 text-left alert-info">
			<h3> Folio: <span id="folio"></span></h3>
		</div>
		<div class="form-group col-md-6 text-left alert-info">
			<h3> Reponsable: {{ user.get_username }}</h3>
		</div>
		<div class="form-group col-md-6">
			<label  class="control-label" for="remision">Agregar Remisión:</label>
			<input type="text" data-toggle="tooltip" data-placement="bottom" title="Agrega Remisión" class="form-control" name="remision" id="remision"></input>
		</div>
		<div class="form-group col-md-6">
			<label  class="control-label" for="cmbApoyo">Selecciona un Apoyo:</label>
			<select name="cmbApoyo" id="cmbApoyo" class="cmbApoyo form-control">
			</select>
		</div>
		<div class="form-group col-md-6">
			<label  class="control-label" for="cmbElemento">Selecciona Elemento:</label>
			<select name="cmbElemento" id="cmbElemento" class="cmbElemento form-control">
			</select>
		</div>
		<div class="form-group col-md-6">
			<label  class="control-label" for="cmbFuncion">Seleccionar Proveedor de Armado:</label>
			<select name="cmbFuncion" id="cmbFuncion" class="cmbFuncion form-control">
			</select>
		</div>
		<div class="form-group col-md-6">
			<label  class="control-label" for="cmbFrente">Selecciona un Frente:</label>
			<select name="cmbFrente" id="cmbFrente" class="cmbFrente form-control">
			</select>
		</div>
		<div class="clearfix"></div>
		<div class="col-md-2">
			<div class="alert-info">&nbsp;</div>
		</div>
		<div class="col-md-4 text-left">
			<div class="alert-default"><b>Peso Original de Recepción</b></div>
		</div>
		<div class="clearfix"></div>
		<div class="col-md-2">
			<div class="alert-success">&nbsp;</div>
		</div>
		<div class="col-md-4 text-left">
			<div class="alert-default"><b>Cantidad Asignada en la Partida</b></div>
		</div>
		<div class="clearfix"></div>
		<div class="col-md-2">
			<div class="alert-warning">&nbsp;</div>
		</div>
		<div class="clear-fix"></div>
		<div class="col-md-4 text-left">
			<div class="alert-default"><b>Detalle de la Diferencia de la Partida</b></div>
		</div>
		<div class="col-md-12 table-responsive">
			<div class="text-center"><h3>Recepción del Material</h3></div>
			<table id="tablaMaterial" class="table table-hover">
				<thead>
					<tr>
						<th class="text-center">No</th>
						<th class="text-center">Nombre Material</th>
						<th class="text-center">Peso Kg</th>
						<th class="text-center">Asignar Cantidad</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<hr>
		<div class="col-md-12 table-responsive">
			<div class="text-center"><h3>Detalle Asignación</h3></div>
			<table id="tablaMaterialDetalle" class="table table-hover">
				<thead>
					<tr>
						<th class="text-center">Nombre Material</th>
						<th class="text-center">Cantidad Asignada</th>
						<th class="text-center">Peso Kg</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div class="col-md-12">
			<button class="btn btn-success" name="btnGuardar" id="btnGuardar">Generar Salida</button>
		</div>
	</div>
	<script type="text/javascript">
		mostrarFolio = function(){
			var modulo = 3;
			$.post( "{% url 'foliosMostrar' %}",{
				modulo: modulo
			},
			function(data, status) {
		            try {
						$("#folio").html(data.folio);
		            } catch (e) {
		                alert("Error al cargar Combo del Fabricante:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Fabricante" );
			});
		}
		comboApoyo = function(){
			$.post( "{% url 'entradaArmadoComboApoyo' %}",{
			},
			function(data, status) {
		            try {
		                $('.cmbApoyo').empty();
		                $('.cmbApoyo').append('<option value="0">Selecciona un Apoyo</option>');
	                    $.each(data.data, function (count, object) {
	                        $('.cmbApoyo').append('<option value="' + object.id + '">' + object.numero + '</option>');
	                    });
		            } catch (e) {
		                alert("Error al cargar Combo del Apoyo:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Apoyo" );
			});
		}
		comboElemento = function(){
			$.post( "{% url 'entradaArmadoComboElemento' %}",{
			},
			function(data, status) {
		            try {
		                $('.cmbElemento').empty();
		                $('.cmbElemento').append('<option value="0">Selecciona un Elemento</option>');
	                    $.each(data.data, function (count, object) {
	                        $('.cmbElemento').append('<option value="' + object.id + '">' + object.nombre + '</option>');
	                    });
		            } catch (e) {
		                alert("Error al cargar Combo del Elemento:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Elemento" );
			});
		}
		materialRecepcionado = function(){
			$("#tablaMaterial tbody").empty();
			var tabla = '';
			var idTabla = 1;
			$.post( "{% url 'entradaArmadoMaterial' %}",{
			},
			function(data, status) {
	            try {
	                $.each(data.data, function (count, object) {
	                    tabla += '<tr>'
	                		tabla +='<td>'+idTabla+'</td>';
	                		tabla +='<td>'+object.materialNombre+'</td>';
	                		tabla +='<td class="info">'+object.cantidadAsignada+'</td>';
	                		tabla +='<td><input type="number" data-toggle="toolinfo" data-placement="bottom" title="Cantidad a Recibir" step="0.01" class="form-control dataAsignacion" name="row_'+count+'" id="row_'+count+'" data-idmaterial="'+object.id+'" data-materialnombre="'+object.materialNombre+'" data-cantidadreal="'+object.cantidadAsignada+'" min="0" value="'+object.cantidadAsignada+'" /></td>';
	                		tabla +='<td style="display:none;" id="nomenclatura_'+count+'"><input type="text" data-toggle="toolinfo" data-placement="bottom" title="Digita la Nomenclatura" title="Nomenclatura" class="form-control" name="txtNomenclatura_'+count+'" id="txtNomenclatura_'+count+'" placeholder="Nomenclatura" /></td>';
	                		tabla +='<td style="display:none;" id="longitud_'+count+'"><input type="number" data-toggle="toolinfo" data-placement="bottom" title="Longitud" title="Longitud" step="0.01" class="form-control" min="0" name="txtLongitud_'+count+'" id="txtLongitud_'+count+'" placeholder="Longitud" /></td>';
	                		tabla +='<td style="display:none;" id="piezas_'+count+'"><input type="number" data-toggle="toolinfo" data-placement="bottom" title="Piezas" title="Piezas" step="0.01" class="form-control" min="0" name="txtPiezas_'+count+'" id="txtPiezas_'+count+'" placeholder="Piezas" /></td>';
	                		tabla +='<td style="display:none;"><input type="text" class="form-control" name="txtBandera_'+count+'" id="txtBandera_'+count+'" value="0"/></td>';
	                		tabla += '<td><button type="button" class="btn btn-info" onClick="agregarAsignacion('+count+');">Recibir</td>';
	                		tabla += '<td id="btnDiferencia_'+count+'"><button type="button" class="btn btn-danger" name="addDiferencia_'+count+'" id="addDiferencia_'+count+'" onClick="agregarDiferencia('+count+');">Diferencia</td>';
	                		tabla += '<td id="btnCancelarDif_'+count+'" style="display:none;"><button type="button" class="btn btn-warning" name="removeDiferencia_'+count+'" id="removeDiferencia_'+count+'" onClick="cancelarDiferencia('+count+');">Cancelar</td>';
	                    tabla +='</tr>';
	                	idTabla++;
	                });
	            } catch (e) {
	                alert("Error al cargar el Material Recepcionado:" + e);
	            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Material Recepcionado" );
			});
			$("#tablaMaterial tbody").append(tabla);
			$('[data-toggle="toolinfo"]').tooltip();
		}
		comboFrente = function(){
			$.post( "{% url 'comboFrente' %}",{
			},
			function(data, status) {
		            try {
		                $('.cmbFrente').empty();
		                $('.cmbFrente').append('<option value="0">Selecciona un Frente</option>');
	                    $.each(data.data, function (count, object) {
	                        $('.cmbFrente').append('<option value="' + object.id + '">' + object.nombre + '</option>');
	                    });
		            } catch (e) {
		                alert("Error al cargar Combo del Frente:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Frente" );
			});
		}
		comboFuncion = function(){
			var tipo = 3;
			$.post( "{% url 'comboFuncion' %}",{
				tipo: tipo
			},
			function(data, status) {
		            try {
		                $('.cmbFuncion').empty();
		                $('.cmbFuncion').append('<option value="0">Selecciona Proveedor de Armado</option>');
	                    $.each(data.data, function (count, object) {
	                        $('.cmbFuncion').append('<option value="' + object.id + '">' + object.proveedor + '</option>');
	                    });
		            } catch (e) {
		                alert("Error al cargar Combo del Fabricante:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición del Fabricante" );
			});
		}
		agregarAsignacion = function(posicion){
			var cantidadAsignada = $("#row_"+posicion).val();
			var cantidadReal = $("#row_"+posicion).data("cantidadreal");
			var idMaterial = $("#row_"+posicion).data("idmaterial");
			var materialNombre = $("#row_"+posicion).data("materialnombre");
			var bandera = $("#txtBandera_"+posicion).val();
			var nomenclatura = $("#txtNomenclatura_"+posicion).val();
			var longitud = $("#txtLongitud_"+posicion).val();
			var piezas = $("#txtPiezas_"+posicion).val();
			var tabla = '';
				tabla += '<tr>';
					tabla += '<td>'+materialNombre+'</td>';
					tabla += '<td class="success">'+cantidadAsignada+'</td>';
					tabla += '<td>'+cantidadReal+'</td>';
					tabla += '<td style="display:none;"><input type="hidden" class="datos" data-datosidmaterial="'+idMaterial+'" data-datoscantidadreal="'+cantidadReal+'" data-datoscantidadasignada="'+cantidadAsignada+'" data-datosnomenclatura="'+nomenclatura+'" data-datoslongitud="'+longitud+'" data-datospiezas="'+piezas+'" data-datosbandera="'+bandera+'" /></td>';
					if(bandera == 1){
						tabla += '<td class="warning"><b>Nomenclatura:</b> '+nomenclatura+'</td>';
						tabla += '<td class="warning"><b>Longitud:</b> '+longitud+'</td>';
						tabla += '<td class="warning"><b>Piezas:</b> '+piezas+'</td>';
					}
				tabla += '</tr>';
			$("#tablaMaterialDetalle").append(tabla);
		}
		agregarDiferencia = function(posicion){
			$("#longitud_"+posicion).show('slide');
			$("#piezas_"+posicion).show('slide');
			$("#nomenclatura_"+posicion).show('slide');
			$("#btnDiferencia_"+posicion).hide('slide');
			$("#btnCancelarDif_"+posicion).show('slide');
			$("#txtBandera_"+posicion).val(1);
		}
		cancelarDiferencia = function(posicion){
			$("#longitud_"+posicion).hide('slide');
			$("#piezas_"+posicion).hide('slide');
			$("#nomenclatura_"+posicion).hide('slide');
			$("#btnDiferencia_"+posicion).show('slide');
			$("#btnCancelarDif_"+posicion).hide('slide');
			$("#txtNomenclatura_"+posicion).val('');
			$("#txtLongitud_"+posicion).val('');
			$("#txtPiezas_"+posicion).val('');
			$("#txtBandera_"+posicion).val(0);
		}
		$( "#btnGuardar" ).click(function() {
			var array = [];
			var remision = $("#remision").val();
			var apoyo = $("#cmbApoyo").val();
			var elemento = $("#cmbElemento").val();
			var funcion = $("#cmbFuncion").val();
			$("input.datos[type=hidden]").each(function(index, element) {
				var material = $(this).data("datosidmaterial");
				var cantidadReal = $(this).data("datoscantidadreal");
				var cantidadAsignada = $(this).data("datoscantidadasignada");
				var nomenclatura = $(this).data("datosnomenclatura");
				var longitud = $(this).data("datoslongitud");
				var piezas = $(this).data("datospiezas");
				var bandera = $(this).data("datosbandera");
				array.push({"material": material,
							"cantidadReal": cantidadReal,
							"cantidadAsignada": cantidadAsignada,
							"nomenclatura": nomenclatura,
							"longitud": longitud,
							"piezas": piezas,
							"bandera": bandera
						});
			});
			var json = JSON.stringify(array);
			$.post( "{% url 'entradaArmadoSave' %}",{
				remision: remision,
				apoyo: apoyo,
				elemento: elemento,
				funcion: funcion,
				json: json
			},
			function(data, status) {
		            try {
		            	mensajeSuccess("<b>"+data.mensaje+"</b>");
		            	$("#folio").html(data.folio);
		            } catch (e) {
		                alert("Error al cargar Guardar la información:" + e);
		            }
			})
			.fail(function() {
				mensajeWarning( "Error en la petición Guardar la información" );
			});
		});
	    $(function () {
	    	mostrarFolio();
	    	comboApoyo();
	    	comboElemento();
	    	comboFrente();
	    	materialRecepcionado();
	    	comboFuncion();
	    });
	</script>
{% endblock %}